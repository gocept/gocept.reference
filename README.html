<?xml version="1.0" encoding="utf-8" ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="generator" content="Docutils 0.4.1: http://docutils.sourceforge.net/" />
<title>Persistent object references</title>
<style type="text/css">

/*
:Author: David Goodger
:Contact: goodger@users.sourceforge.net
:Date: $Date: 2005-12-18 01:56:14 +0100 (Sun, 18 Dec 2005) $
:Revision: $Revision: 4224 $
:Copyright: This stylesheet has been placed in the public domain.

Default cascading style sheet for the HTML output of Docutils.

See http://docutils.sf.net/docs/howto/html-stylesheets.html for how to
customize this style sheet.
*/

/* used to remove borders from tables and images */
.borderless, table.borderless td, table.borderless th {
  border: 0 }

table.borderless td, table.borderless th {
  /* Override padding for "table.docutils td" with "! important".
     The right padding separates the table cells. */
  padding: 0 0.5em 0 0 ! important }

.first {
  /* Override more specific margin styles with "! important". */
  margin-top: 0 ! important }

.last, .with-subtitle {
  margin-bottom: 0 ! important }

.hidden {
  display: none }

a.toc-backref {
  text-decoration: none ;
  color: black }

blockquote.epigraph {
  margin: 2em 5em ; }

dl.docutils dd {
  margin-bottom: 0.5em }

/* Uncomment (and remove this text!) to get bold-faced definition list terms
dl.docutils dt {
  font-weight: bold }
*/

div.abstract {
  margin: 2em 5em }

div.abstract p.topic-title {
  font-weight: bold ;
  text-align: center }

div.admonition, div.attention, div.caution, div.danger, div.error,
div.hint, div.important, div.note, div.tip, div.warning {
  margin: 2em ;
  border: medium outset ;
  padding: 1em }

div.admonition p.admonition-title, div.hint p.admonition-title,
div.important p.admonition-title, div.note p.admonition-title,
div.tip p.admonition-title {
  font-weight: bold ;
  font-family: sans-serif }

div.attention p.admonition-title, div.caution p.admonition-title,
div.danger p.admonition-title, div.error p.admonition-title,
div.warning p.admonition-title {
  color: red ;
  font-weight: bold ;
  font-family: sans-serif }

/* Uncomment (and remove this text!) to get reduced vertical space in
   compound paragraphs.
div.compound .compound-first, div.compound .compound-middle {
  margin-bottom: 0.5em }

div.compound .compound-last, div.compound .compound-middle {
  margin-top: 0.5em }
*/

div.dedication {
  margin: 2em 5em ;
  text-align: center ;
  font-style: italic }

div.dedication p.topic-title {
  font-weight: bold ;
  font-style: normal }

div.figure {
  margin-left: 2em ;
  margin-right: 2em }

div.footer, div.header {
  clear: both;
  font-size: smaller }

div.line-block {
  display: block ;
  margin-top: 1em ;
  margin-bottom: 1em }

div.line-block div.line-block {
  margin-top: 0 ;
  margin-bottom: 0 ;
  margin-left: 1.5em }

div.sidebar {
  margin-left: 1em ;
  border: medium outset ;
  padding: 1em ;
  background-color: #ffffee ;
  width: 40% ;
  float: right ;
  clear: right }

div.sidebar p.rubric {
  font-family: sans-serif ;
  font-size: medium }

div.system-messages {
  margin: 5em }

div.system-messages h1 {
  color: red }

div.system-message {
  border: medium outset ;
  padding: 1em }

div.system-message p.system-message-title {
  color: red ;
  font-weight: bold }

div.topic {
  margin: 2em }

h1.section-subtitle, h2.section-subtitle, h3.section-subtitle,
h4.section-subtitle, h5.section-subtitle, h6.section-subtitle {
  margin-top: 0.4em }

h1.title {
  text-align: center }

h2.subtitle {
  text-align: center }

hr.docutils {
  width: 75% }

img.align-left {
  clear: left }

img.align-right {
  clear: right }

ol.simple, ul.simple {
  margin-bottom: 1em }

ol.arabic {
  list-style: decimal }

ol.loweralpha {
  list-style: lower-alpha }

ol.upperalpha {
  list-style: upper-alpha }

ol.lowerroman {
  list-style: lower-roman }

ol.upperroman {
  list-style: upper-roman }

p.attribution {
  text-align: right ;
  margin-left: 50% }

p.caption {
  font-style: italic }

p.credits {
  font-style: italic ;
  font-size: smaller }

p.label {
  white-space: nowrap }

p.rubric {
  font-weight: bold ;
  font-size: larger ;
  color: maroon ;
  text-align: center }

p.sidebar-title {
  font-family: sans-serif ;
  font-weight: bold ;
  font-size: larger }

p.sidebar-subtitle {
  font-family: sans-serif ;
  font-weight: bold }

p.topic-title {
  font-weight: bold }

pre.address {
  margin-bottom: 0 ;
  margin-top: 0 ;
  font-family: serif ;
  font-size: 100% }

pre.literal-block, pre.doctest-block {
  margin-left: 2em ;
  margin-right: 2em ;
  background-color: #eeeeee }

span.classifier {
  font-family: sans-serif ;
  font-style: oblique }

span.classifier-delimiter {
  font-family: sans-serif ;
  font-weight: bold }

span.interpreted {
  font-family: sans-serif }

span.option {
  white-space: nowrap }

span.pre {
  white-space: pre }

span.problematic {
  color: red }

span.section-subtitle {
  /* font-size relative to parent (h1..h6 element) */
  font-size: 80% }

table.citation {
  border-left: solid 1px gray;
  margin-left: 1px }

table.docinfo {
  margin: 2em 4em }

table.docutils {
  margin-top: 0.5em ;
  margin-bottom: 0.5em }

table.footnote {
  border-left: solid 1px black;
  margin-left: 1px }

table.docutils td, table.docutils th,
table.docinfo td, table.docinfo th {
  padding-left: 0.5em ;
  padding-right: 0.5em ;
  vertical-align: top }

table.docutils th.field-name, table.docinfo th.docinfo-name {
  font-weight: bold ;
  text-align: left ;
  white-space: nowrap ;
  padding-left: 0 }

h1 tt.docutils, h2 tt.docutils, h3 tt.docutils,
h4 tt.docutils, h5 tt.docutils, h6 tt.docutils {
  font-size: 100% }

tt.docutils {
  background-color: #eeeeee }

ul.auto-toc {
  list-style-type: none }

</style>
</head>
<body>
<div class="document" id="persistent-object-references">
<h1 class="title">Persistent object references</h1>
<p>This package provides a reference implementation.</p>
<p>The specific properties of this implementation are:</p>
<ul class="simple">
<li>intended to be used for intrinsic references</li>
<li>provides integrity enforcement</li>
<li>modelled partially after relational <cite>foreign keys</cite></li>
</ul>
<div class="section">
<h1><a id="motivation" name="motivation">Motivation</a></h1>
<p>When developing an application we often find the need to reference objects that
are managed within the application itself. Those objects are typically <cite>master
data</cite>-like and are managed centrally within the application.</p>
<p>The reference to those objects is typically intrinsic to the application we
develop so they should behave like normal Python object references that are
under the control of our application.</p>
<p>Within the world of Zope and ZODB there are different ways to achieve this. The
various approaches have different semantics and side effects. Our goal is to
unify the way of intrinsically referencing objects and to provide an ability to
switch between different semantics as needed without rewriting application code
and without the need to migrate persistent data structures (at least from the
application's point of view).</p>
</div>
<div class="section">
<h1><a id="model-comparison" name="model-comparison">Model comparison</a></h1>
<p>Our goal was to determine the advantages and disadvantages of the different
approaches. We included three general approaches from the world of
Python/Zope/ZODB and also the standard relational approach to normalisation
tables.</p>
<p>We used four criteria to describe each solution:</p>
<dl class="docutils">
<dt>Reference data</dt>
<dd>What data is stored to describe the reference.</dd>
<dt>Reference semantic</dt>
<dd>What meaning does the reference have? How can the meaning change?</dd>
<dt>Integrity</dt>
<dd>What might happen to my application if data that is involved in the reference might change or become deleted?</dd>
<dt>Set/Lookup</dt>
<dd><p class="first">What do I (as an application developer) have to do to set a reference or look up a referenced object?</p>
<table border="1" class="docutils">
<colgroup>
<col width="11%" />
<col width="21%" />
<col width="22%" />
<col width="20%" />
<col width="26%" />
</colgroup>
<tbody valign="top">
<tr><td>Property</td>
<td>Python references</td>
<td>Weak references</td>
<td>Key reference</td>
<td>Relational DBs</td>
</tr>
</tbody>
</table>
<p>Reference data            OID                                           OID                                           application-specific key                    application-specific (primary key + table name)</p>
<dl class="docutils">
<dt>Reference semantic        Refers to a specific                          Refers to a spec  ific                        Refers to an object which                   Refers to an object (row) that is associated</dt>
<dd><dl class="first last docutils">
<dt>Python object                                 Python object                                 is associated with the saved key            with the primary key at the moment of the lookup.</dt>
<dd>at the moment of lookup.</dd>
</dl>
</dd>
<dt>Integrity                 The reference stays valid, however,           The reference mi  ght have become stale       The reference might have become             Dependening on the use of <cite>foreign keys</cite></dt>
<dd>the target object might have lost its         and leave the re  ferencing object in an      stale.                                      and the databases implementation of constraints.
meaning for the application.                  invalid state.                                                                            Can usually be forced to stay valid.</dd>
<dt>Set/Lookup                Normal Python attribute access.               Use WeakRef-wrap  per to store and            Depends on the implementation.              Explicitly store the primary key.</dt>
<dd>__call__ to look  up. Might use properties    Might use properties for convenience.       Use JOIN to look up.
for convenience.</dd>
</dl>
<div class="system-message">
<p class="system-message-title">System Message: WARNING/2 (<tt class="docutils">README.txt</tt>, line 74)</p>
Definition list ends without a blank line; unexpected unindent.</div>
<div class="last system-message">
<p class="system-message-title">System Message: ERROR/3 (<tt class="docutils">README.txt</tt>, line 74)</p>
<p>Malformed table.
No bottom table border found.</p>
<pre class="literal-block">
======================    =========================================     ===========================================   ========================================    ====================================================

</pre>
</div>
</dd>
</dl>
</div>
<div class="section">
<h1><a id="observations" name="observations">Observations</a></h1>
<ul>
<li><p class="first">Relational: every object (row) has a canonical place that defines a primary
key.</p>
<p>The ZODB (like a filesystem) can have multiple hard links to an object.
Objects are deleted when the last hard link to an object is removed. This
makes it impossible to use hard links for referencing an object because
object deletion will not be noticed and the objects will continue to live.
The ZODB itself does not have a notion of a canonical place where an object
is defined.</p>
</li>
<li><p class="first">Relational: When referencing an object we can enforce integrity by declaring
a foreign key. This is orthogonal to the data stored.</p>
</li>
<li><p class="first">Relational: As an application-level key is used for identіfying the target
of a reference the application can choose to delete a row and re-add a row
with the same primary key later. If the integrity is enforced this requires
support on the database level to temporarily ignore broken foreign keys.</p>
</li>
<li><p class="first">Normal Python references embed themselves naturally in the application.
Properties allow hiding implementation on how references are looked
up/stored.</p>
</li>
</ul>
</div>
<div class="section">
<h1><a id="conclusions-requirements-for-the-reference-implementation" name="conclusions-requirements-for-the-reference-implementation">Conclusions / Requirements for the reference implementation</a></h1>
<ul>
<li><p class="first">Allow configuration of <cite>foreign key</cite> constraints (none, always,
end-of-transaction). This selection must be possible to be changed afterwards
and provide an automatic migration path.</p>
</li>
<li><p class="first">Use application level keys to refer to an object.</p>
</li>
<li><p class="first">Use a canonical location and a primary key to store objects and to determine
whether an object was deleted.</p>
</li>
<li><p class="first">Distinguish between two use cases when modifying an object's key:</p>
<p>1. The application references the right object but it has the wrong key (as
the key might have meaning for the application). In this case the object must
be updated to receive the new, correct key and the references must be updated
to refer to this new key.</p>
<p>2. The application references the wrong object with the right key. In this
case the object with the referenced key must be moved away and the key must
be given to the new object.</p>
</li>
</ul>
</div>
<div class="section">
<h1><a id="implementation-notes" name="implementation-notes">Implementation notes</a></h1>
<ul class="simple">
<li>Canonical location is determined by location/containment. The primary key for
a reference is the referenced object's location.</li>
<li>Constraints are enforced by monitoring containment events.</li>
<li>The different ways of updating/changing a key's meaning are supported by an indirection
that enumerates all keys and stores a <cite>reference id</cite> on the referencing object
instead of the location. The two use cases for changing the meaning are
reflected to either:<ol class="arabic">
<li>associate a new path with an existing reference id</li>
<li>associate a new reference id with an existing path</li>
</ol>
</li>
</ul>
</div>
</div>
</body>
</html>
